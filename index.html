<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>JungschÃ¼tzen Amtscup</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e3a8a">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#eef2f7;margin:0}
.container{max-width:1200px;margin:auto;padding:1rem}
h1{color:#1e3a8a}
h2{color:#1d4ed8}
.card{background:#fff;border-radius:14px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.row{display:flex;gap:.75rem;flex-wrap:wrap}
.field{flex:1;min-width:220px}
label{font-size:.8rem;font-weight:600}
input,select{width:100%;padding:.45rem;border-radius:8px;border:1px solid #cbd5f5;font-size:14px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.35rem;text-align:center}
th{background:#dbeafe}
td.name input{width:100%}
td.year input{width:70px;text-align:center}
td.gender select{width:60px}
td.res input{width:60px;text-align:center}
button{border:none;border-radius:999px;padding:.9rem;font-size:1rem;cursor:pointer;background:#2563eb;color:white;width:100%}
.winner-ok{background:#dcfce7;padding:.7rem;border-radius:12px;font-weight:700}
.winner-none{background:#e5e7eb;padding:.7rem;border-radius:12px}
.notice{background:#fff7ed;border:1px solid #fdba74;border-radius:12px;padding:.9rem;font-size:.9rem}
</style>
</head>

<body>
<div class="container">

<h1>JungschÃ¼tzen Amtscup</h1>

<div class="card">
<h2>Anleitung</h2>
<p>
Du kannst eine oder zwei Gruppen melden, bei 3er Paarungen alle 3 Gruppen mÃ¶glich.<br>
Mindestens eine Gruppe muss komplett ausgefÃ¼llt sein.<br>
Nach dem Senden dem Mail das Standblatt als Datei oder Bild anhÃ¤ngen.
</p>
<p>ğŸ”¥ Danke fÃ¼r das Melden der Resultate Ã¼ber diese App</p>
</div>

<div class="card">
<h2>1. Gruppenauswahl</h2>
<div class="row">
 <div class="field"><label>Gruppe 1 *</label><select id="g1"></select></div>
 <div class="field"><label>Gruppe 2</label><select id="g2"></select></div>
 <div class="field"><label>Gruppe 3</label><select id="g3"></select></div>
</div>
</div>

<div id="groups"></div>

<div class="card">
<h2>Sieger</h2>
<div id="winner" class="winner-none">â€“</div>
</div>

<div class="card notice">
<strong>ğŸ“¸ Wichtig:</strong><br>
Bitte <b>Foto oder Scan des ausgefÃ¼llten Standblattes</b><br>
<b>manuell dem E-Mail anhÃ¤ngen</b>, bevor es gesendet wird.
</div>

<div class="card">
<button onclick="sendResult()">ğŸ“§ Resultat per Mail senden</button>
</div>

</div>

<script>
const RESULT_EMAIL = "thomannpeter@bluewin.ch";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxY713DH_zIQ51cRn1sr8Ntywr1GTDn-NcW5PkBEN0FGtm3gopQMR2VSEH15sz9tjMi/exec";
const state = {};

async function loadGroups(){
 let list = [];
 try{
  const r = await fetch("gruppen.txt?v=" + Date.now());
  if(!r.ok) throw "Fehlt";
  list = (await r.text()).split(/\r?\n/).filter(Boolean);
 }catch(e){
  list = ["Gruppe 1","Gruppe 2","Gruppe 3"];
 }
 ["g1","g2","g3"].forEach(id=>{
  const s = document.getElementById(id);
  s.innerHTML = "<option value=''>Bitte wÃ¤hlenâ€¦</option>";
  list.forEach(g => s.add(new Option(g,g)));
  s.onchange = () => selectGroup(id);
 });
}

function selectGroup(id){
 const name = document.getElementById(id).value;
 if(!name) return;
 if(!state[id]) state[id] = { name, rows:[{},{},{},{}] };
 renderGroups();
}

function renderGroups(){
 groups.innerHTML="";
 Object.keys(state).forEach((id,i)=>{
  const g = state[id];
  const c = document.createElement("div");
  c.className="card";
  c.innerHTML = `
   <h2>SchÃ¼tzen â€“ Gruppe ${i+1}: ${g.name}</h2>
   <table>
    <thead><tr><th>#</th><th>Name</th><th>Jahrgang</th><th>Gender</th><th>Resultat</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><th colspan="4">Summe</th><th class="sum">0</th></tr></tfoot>
   </table>`;
  const tb = c.querySelector("tbody");

  g.rows.forEach((r,idx)=>{
   const tr = document.createElement("tr");
   tr.innerHTML = `
    <td>${idx+1}</td>
    <td class="name"><input value="${r.n||""}"></td>
    <td class="year"><input value="${r.y||""}"></td>
    <td class="gender">
      <select>
        <option value=""></option>
        <option value="m">m</option>
        <option value="w">w</option>
      </select>
    </td>
    <td class="res"><input value="${r.r||""}"></td>`;
   const i = tr.querySelectorAll("input,select");
   i[0].oninput = e => r.n = e.target.value;
   i[1].oninput = e => r.y = e.target.value;
   i[2].onchange = e => r.g = e.target.value;
   i[3].oninput = e => { r.r = e.target.value; updateSum(c,g); };
   tb.appendChild(tr);
  });

  groups.appendChild(c);
  updateSum(c,g);
 });
 calcWinner();
}

function updateSum(card,g){
 card.querySelector(".sum").textContent =
  g.rows.reduce((a,b)=>a+(+b.r||0),0);
 calcWinner();
}

function calcWinner(){
 const arr = Object.values(state)
  .map(g=>({ n:g.name, t:g.rows.reduce((a,b)=>a+(+b.r||0),0) }))
  .filter(x=>x.t>0);
 if(arr.length < 2){
  winner.textContent = "â€“";
  winner.className = "winner-none";
  return;
 }
 arr.sort((a,b)=>b.t-a.t);
 winner.className = "winner-ok";
 if(arr.length === 2){
  winner.innerHTML = `ğŸ† Sieger: ${arr[0].n} (${arr[0].t})<br>âŒ Verlierer: ${arr[1].n} (${arr[1].t})`;
 } else {
  winner.innerHTML = `ğŸ† Sieger: ${arr[0].n} & ${arr[1].n}<br>âŒ Verlierer: ${arr[2].n}`;
 }
}

function sendResult(){
 if(!Object.keys(state).length){
  alert("Mindestens eine Gruppe wÃ¤hlen.");
  return;
 }

 let rowsForGoogle = [];
 let body = "JUNGSCHUETZEN AMTSCUP â€“ RESULTAT\n\n";

 Object.values(state).forEach((g,idx)=>{
  body += "GRUPPE " + (idx+1) + ": " + g.name + "\n";
  body += "Nr; Name; Jahrgang; Gender; Resultat\n";
  g.rows.forEach((r,i)=>{
   if(r.n || r.r){
    body += (i+1)+"; "+(r.n||"")+"; "+(r.y||"")+"; "+(r.g||"")+"; "+(r.r||"0")+"\n";
    rowsForGoogle.push({
      gruppe: g.name,
      nr: i+1,
      name: r.n||"",
      jahrgang: r.y||"",
      gender: r.g||"",
      resultat: r.r||"0"
    });
   }
  });
  body += "Summe Gruppe " + (idx+1) + ": " +
          g.rows.reduce((a,b)=>a+(+b.r||0),0) + "\n\n";
 });

 body += "HINWEIS: Bitte Standblatt-Foto / Scan dem E-Mail anhÃ¤ngen.\n";

 const mailto =
  "mailto:" + RESULT_EMAIL +
  "?subject=" + encodeURIComponent("Jungschuetzen Amtscup Resultat") +
  "&body=" + encodeURIComponent(body);

 // Zuerst Google senden
 fetch(SCRIPT_URL, {
  method: "POST",
  headers: {"Content-Type":"application/json"},
  body: JSON.stringify({ rows: rowsForGoogle })
 })
 .then(r => r.text())
 .then(t => {
   alert("Google-Antwort: " + t);
   window.open(mailto, "_blank");
 })
 .catch(e => {
   alert("Google-Fehler: " + e);
   window.open(mailto, "_blank");
 });
}

loadGroups();
</script>
</body>
</html>
