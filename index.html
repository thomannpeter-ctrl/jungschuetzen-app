<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Amtscup ‚Äì Cup-Duell</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#eef2f7;margin:0;color:#111827}
.container{max-width:1200px;margin:auto;padding:1rem}
h1{color:#1e3a8a}
h2{color:#1d4ed8;margin:.5rem 0}
.card{background:#fff;border-radius:14px;padding:1rem 1.25rem;
box-shadow:0 4px 10px rgba(15,23,42,.08);margin-bottom:1rem}
.row{display:flex;gap:.75rem;flex-wrap:wrap}
.field{flex:1;min-width:220px}
label{font-size:.8rem;font-weight:600}
input,select{width:100%;padding:.45rem;border-radius:8px;border:1px solid #cbd5f5}
.input-year{max-width:80px}
.input-result{max-width:70px}
th.gear,td.gear{width:90px}
th.zcol,td.zcol{width:65px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.4rem;text-align:center}
th{background:#dbeafe}
button{border:none;border-radius:999px;padding:.8rem;font-size:1rem;cursor:pointer;
background:#2563eb;color:white;width:100%}
.winner{padding:.7rem;border-radius:12px;font-weight:700}
.winner-ok{background:#dcfce7;color:#166534}
.winner-none{background:#e5e7eb;color:#374151}
</style>
</head>

<body>
<div class="container">

<h1>Amtscup ‚Äì Cup-Duell</h1>

<div class="card">
<h2>1. Gruppenchef</h2>
<div class="row">
  <div class="field"><label>Name</label><input id="chef"></div>
  <div class="field"><label>E-Mail</label><input id="email" type="email"></div>
</div>
</div>

<div class="card">
<h2>2. Gruppenauswahl</h2>
<div class="row">
  <div class="field"><label>Gruppe 1 *</label><select id="g1"></select></div>
  <div class="field"><label>Gruppe 2 *</label><select id="g2"></select></div>
  <div class="field"><label>Gruppe 3</label><select id="g3"></select></div>
</div>
</div>

<!-- üîπ Gruppen anfangs versteckt -->
<div id="groups" style="display:none"></div>

<div class="card">
<h2>Sieger</h2>
<div id="winner" class="winner winner-none">Noch keine Resultate</div>
</div>

<div class="card">
<button onclick="sendResult()">üìß Resultat per Mail senden</button>
</div>

<div class="card">
<button onclick="sendToGoogle()">üìä In Google Tabelle speichern</button>
</div>

</div>

<script>
/* ================= KONFIG ================= */
const RESULT_EMAIL="thomannpeter@bluewin.ch";
const GOOGLE_URL="https://script.google.com/macros/s/AKfycbzv3eifzrGNnxJ46NyofE_g-T_TcuGC37BxtkpKKoDh97NFn8c56rAujWMYnA1DlZos_g/exec";

const SPORTGERAETE=[
 {n:"",z:0},{n:"Standard",z:0},{n:"FG",z:0},
 {n:"Karabiner",z:4},{n:"57/02",z:8},{n:"57/03",z:4},
 {n:"90BK",z:4},{n:"90RK",z:4}
];
const zus=g=>(SPORTGERAETE.find(x=>x.n===g)||{z:0}).z;

/* ================= APP ================= */
async function loadGroups(){
 const r=await fetch("gruppen.txt?ts="+Date.now());
 const list=(await r.text()).split(/\r?\n/).filter(x=>x.trim());
 ["g1","g2","g3"].forEach(id=>{
  const s=document.getElementById(id);
  s.innerHTML="<option value=''>Bitte w√§hlen‚Ä¶</option>";
  list.forEach(g=>{
   const o=document.createElement("option");
   o.value=o.textContent=g;
   s.appendChild(o);
  });
  s.onchange=buildGroups;
 });
}

function buildGroups(){
 const container=document.getElementById("groups");
 container.innerHTML="";

 let anySelected=false;

 [1,2,3].forEach(n=>{
  const name=document.getElementById("g"+n).value;
  if(!name) return;
  anySelected=true;
  container.appendChild(createGroup(n,name));
 });

 container.style.display = anySelected ? "block" : "none";
 calcWinner();
}

function createGroup(n,name){
 const c=document.createElement("div");
 c.className="card";
 c.dataset.name=name;
 c.innerHTML=`
 <h2>Gruppe ${n}: ${name}</h2>
 <table>
 <thead><tr>
 <th>#</th><th>Name</th><th>Jahrgang</th>
 <th class="gear">Sportger√§t</th><th>Resultat</th>
 <th class="zcol">Zuschlag</th><th>Total</th>
 </tr></thead>
 <tbody></tbody>
 <tfoot><tr><th colspan="4">Summe</th>
 <th class="sr">0</th><th class="sz">0</th><th class="st">0</th>
 </tr></tfoot>
 </table>`;
 const tb=c.querySelector("tbody");

 for(let i=1;i<=5;i++){
  const tr=document.createElement("tr");
  tr.innerHTML=`
  <td>${i}</td>
  <td><input class="n"></td>
  <td><input class="y input-year"></td>
  <td class="gear"><select class="g"></select></td>
  <td><input class="r input-result"></td>
  <td class="zcol z">0</td><td class="t">0</td>`;
  SPORTGERAETE.forEach(s=>{
   const o=document.createElement("option");
   o.value=o.textContent=s.n;
   tr.querySelector(".g").appendChild(o);
  });
  tr.querySelectorAll("input,select").forEach(e=>e.oninput=()=>calc(c));
  tb.appendChild(tr);
 }
 return c;
}

function calc(c){
 let sr=0,sz=0,st=0;
 c.querySelectorAll("tbody tr").forEach(tr=>{
  const r=+tr.querySelector(".r").value||0;
  const z=zus(tr.querySelector(".g").value);
  tr.querySelector(".z").textContent=z;
  tr.querySelector(".t").textContent=r+z;
  sr+=r;sz+=z;st+=r+z;
 });
 c.querySelector(".sr").textContent=sr;
 c.querySelector(".sz").textContent=sz;
 c.querySelector(".st").textContent=st;
 calcWinner();
}

function calcWinner(){
 const cards=[...document.querySelectorAll("#groups .card")];
 const d=cards.map(c=>({n:c.dataset.name,t:+c.querySelector(".st").textContent}))
             .filter(x=>x.t>0).sort((a,b)=>b.t-a.t);
 if(!d.length){winner.textContent="Noch keine Resultate";return;}
 winner.className="winner winner-ok";
 winner.innerHTML=`üèÜ Sieger: ${d[0].n} (${d[0].t})`;
}

/* ===== Mail ===== */
function sendResult(){
 let body=`AMTSCUP CUP-DUELL\n\nGruppenchef: ${chef.value}\nE-Mail: ${email.value}\n\n`;
 document.querySelectorAll("#groups .card").forEach((c,i)=>{
  body+=`GRUPPE ${i+1}: ${c.dataset.name}\n`;
  body+="Name;Jahrgang;Sportger√§t;Resultat;Zuschlag;Total\n";
  c.querySelectorAll("tbody tr").forEach(tr=>{
   const n=tr.querySelector(".n").value;
   const r=tr.querySelector(".r").value;
   if(n||r)
    body+=`${n};${tr.querySelector(".y").value};${tr.querySelector(".g").value};${r};${tr.querySelector(".z").textContent};${tr.querySelector(".t").textContent}\n`;
  });
  body+="\n";
 });
 body+="SIEGER:\n"+winner.textContent;
 location.href=`mailto:${RESULT_EMAIL}?subject=${encodeURIComponent("Amtscup Resultat")}&body=${encodeURIComponent(body)}`;
}

/* ===== Google Tabelle ===== */
function sendToGoogle(){
 const rows=[];
 document.querySelectorAll("#groups .card").forEach(c=>{
  const gruppe=c.dataset.name;
  c.querySelectorAll("tbody tr").forEach(tr=>{
   const name=tr.querySelector(".n").value;
   const r=tr.querySelector(".r").value;
   if(!name&&!r) return;
   rows.push({
     gruppe,
     name,
     jahr:tr.querySelector(".y").value,
     geraet:tr.querySelector(".g").value,
     resultat:r,
     zuschlag:tr.querySelector(".z").textContent,
     total:tr.querySelector(".t").textContent
   });
  });
 });

 fetch(GOOGLE_URL,{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({chef:chef.value,email:email.value,rows})
 })
 .then(()=>alert("‚úÖ Erfolgreich in Google Tabelle gespeichert"))
 .catch(()=>alert("‚ùå Fehler beim Senden"));
}

loadGroups();
</script>
</body>
</html>
