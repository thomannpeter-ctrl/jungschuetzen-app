<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Amtscup JungschÃ¼tzen â€“ Cup-Duell</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#eef2f7;margin:0;color:#111827}
.container{max-width:1100px;margin:auto;padding:1rem}
h1{color:#1e3a8a}
h2{color:#1d4ed8;margin:0}
.card{background:#fff;border-radius:12px;padding:1rem 1.25rem;box-shadow:0 4px 10px rgba(15,23,42,.08);margin-bottom:1rem}
.row{display:flex;flex-wrap:wrap;gap:.75rem;margin-bottom:.5rem}
.field{flex:1;min-width:180px}
label{font-size:.8rem;font-weight:600}
input,select{width:100%;padding:.45rem;border-radius:8px;border:1px solid #cbd5f5}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.35rem;text-align:center}
th{background:#dbeafe}
.sum-cell{background:#f3f4f6;font-weight:700}
.group-title{font-weight:700;margin:.5rem 0;color:#0f172a}
button{border:none;border-radius:999px;padding:.6rem 1rem;font-size:.9rem;cursor:pointer}
.btn-primary{background:#2563eb;color:#fff}
.btn-secondary{background:#e5e7eb}
.winner-box{padding:.6rem;border-radius:999px;font-weight:700}
.winner-none{background:#e5e7eb}
.winner-g1{background:#dcfce7;color:#166534}
.winner-g2{background:#dbeafe;color:#1d4ed8}
.winner-g3{background:#fee2e2;color:#991b1b}
.winner-draw{background:#fef9c3;color:#854d0e}
.small-note{font-size:.8rem;color:#6b7280;margin-top:.25rem}
.error{border-color:#dc2626 !important;background:#fee2e2 !important}
</style>
</head>

<body>
<div class="container">

<h1>Amtscup JungschÃ¼tzen â€“ Cup-Duell</h1>

<!-- 1. Gruppen -->
<div class="card">
  <h2>1. Gruppenchef & Gruppen</h2>

  <div class="row">
    <div class="field">
      <label>Name</label>
      <input id="chef" placeholder="Name Vorname">
    </div>
    <div class="field">
      <label>E-Mail</label>
      <input id="email" type="email" placeholder="name@verein.ch">
    </div>
  </div>

  <!-- Gruppenauswahl: UNTEREINANDER -->
  <div class="row">
    <div class="field">
      <label>Gruppe 1</label>
      <select id="g1"></select>
    </div>
  </div>
  <div class="row">
    <div class="field">
      <label>Gruppe 2</label>
      <select id="g2"></select>
    </div>
  </div>
  <div class="row" id="g3Row" style="display:none">
    <div class="field">
      <label>Gruppe 3 (optional)</label>
      <select id="g3"></select>
    </div>
  </div>

  <button class="btn-secondary" id="toggleG3" type="button">âž• 3. Gruppe hinzufÃ¼gen</button>
  <div class="small-note">Gruppen werden aus <code>gruppen.txt</code> geladen.</div>
</div>

<!-- Gruppen -->
<div id="groups"></div>

<!-- Sieger -->
<div class="card">
  <h2>Vergleich & Sieger</h2>
  <div id="winner" class="winner-box winner-none">Noch keine Resultate</div>
</div>

<!-- Speichern -->
<div class="card">
  <button class="btn-primary" type="button" onclick="saveAll()">ðŸ“¤ Speichern (Google-Tabelle + E-Mail)</button>
  <div class="small-note">
    Speichert zuerst in Google Sheets. Danach wird dein Mailprogramm mit einer fertigen Mail an
    <strong>thomannpeter@bluewin.ch</strong> geÃ¶ffnet.
  </div>
</div>

</div>

<script>
/* ===================== KONFIG ===================== */
const SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbzdbePK-rK_4lyEQiyqw51Vi2n0gUPR-llwRs5ozs1FGGj3E-xzo9jwS7pbLrCwbfOUzg/exec";

const RESULT_EMAIL = "thomannpeter@bluewin.ch";

let group3Enabled = false;

/* ===================== GRUPPEN LADEN ===================== */
function parseGroups(t){
  return t.split(/\r?\n/).map(l=>l.trim()).filter(l=>l && !l.startsWith("#"));
}

async function loadGroups(){
  const r = await fetch("gruppen.txt?ts="+Date.now(),{cache:"no-store"});
  if(!r.ok) throw new Error("gruppen.txt nicht gefunden");
  const g = parseGroups(await r.text());

  ["g1","g2","g3"].forEach(id=>{
    const s=document.getElementById(id);
    if(!s) return;
    s.innerHTML="<option value=''>Bitte wÃ¤hlen â€¦</option>";
    g.forEach(x=>{
      const o=document.createElement("option");
      o.value=o.textContent=x;
      s.appendChild(o);
    });
  });
}

/* ===================== GRUPPEN TABELLE ===================== */
function createGroup(n){
  const c=document.createElement("div");
  c.className="card";
  c.id="group"+n;
  c.innerHTML=`
    <h2>SchÃ¼tzen â€“ Gruppe ${n}</h2>
    <div id="title${n}" class="group-title">â€“</div>
    <table>
      <thead><tr><th>#</th><th>Name*</th><th>Jahrgang*</th><th>Resultat*</th></tr></thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <th colspan="3">Summe Gruppe ${n}</th>
          <th id="sum${n}" class="sum-cell">0</th>
        </tr>
      </tfoot>
    </table>`;

  const tb=c.querySelector("tbody");
  for(let i=1;i<=4;i++){
    tb.innerHTML+=`
      <tr>
        <td>${i}</td>
        <td><input class="name"></td>
        <td><input type="number" class="year"></td>
        <td><input type="number" class="res"></td>
      </tr>`;
  }
  tb.querySelectorAll(".res").forEach(i=>i.oninput=()=>calc(n));
  document.getElementById("groups").appendChild(c);
}

/* ===================== TITEL ===================== */
function updateTitles(){
  title1.textContent = g1.value || "â€“";
  title2.textContent = g2.value || "â€“";
  if(group3Enabled) title3.textContent = g3.value || "â€“";
}

/* ===================== SUMMEN ===================== */
function calc(n){
  let s=0;
  document.querySelectorAll(`#group${n} .res`).forEach(i=>s += parseInt(i.value)||0);
  document.getElementById("sum"+n).textContent = s;
  updateWinner();
}

/* ===================== SIEGER ===================== */
function updateWinner(){
  const arr=[
    {n:1,v:+sum1.textContent||0, name:g1.value || "Gruppe 1"},
    {n:2,v:+sum2.textContent||0, name:g2.value || "Gruppe 2"},
    ...(group3Enabled ? [{n:3,v:+sum3.textContent||0, name:g3.value || "Gruppe 3"}] : [])
  ].filter(x=>x.v>0);

  const b=winner;
  if(!arr.length){b.textContent="Noch keine Resultate";b.className="winner-box winner-none";return;}

  arr.sort((a,b)=>b.v-a.v);
  const best = arr[0];
  const tied = arr.filter(x=>x.v===best.v);

  if(tied.length>1){
    b.textContent="ðŸ¤ Unentschieden ("+best.v+") â€“ " + tied.map(x=>x.name).join(" / ");
    b.className="winner-box winner-draw";
  }else{
    b.textContent="ðŸ† Sieger: " + best.name + " (Total " + best.v + ")";
    b.className="winner-box winner-g"+best.n;
  }
}

/* ===================== GRUPPE 3 TOGGLE ===================== */
toggleG3.onclick=()=>{
  if(!group3Enabled){
    group3Enabled=true;
    g3Row.style.display="block";
    createGroup(3);
    toggleG3.textContent="âž– 3. Gruppe entfernen";
    g3.onchange=updateTitles;
    updateTitles();
  }else{
    if(!confirm("Gruppe 3 wirklich entfernen?")) return;
    group3Enabled=false;
    g3Row.style.display="none";
    document.getElementById("group3")?.remove();
    toggleG3.textContent="âž• 3. Gruppe hinzufÃ¼gen";
    updateWinner();
  }
};

/* ===================== VALIDIERUNG ===================== */
function clearErrors(){
  document.querySelectorAll(".error").forEach(x=>x.classList.remove("error"));
}

function validate(){
  clearErrors();

  if(!chef.value.trim()){ chef.classList.add("error"); alert("Bitte Name Gruppenchef eingeben."); return false; }
  if(!email.value.trim()){ email.classList.add("error"); alert("Bitte E-Mail eingeben."); return false; }
  if(!g1.value){ g1.classList.add("error"); alert("Bitte Gruppe 1 wÃ¤hlen."); return false; }
  if(!g2.value){ g2.classList.add("error"); alert("Bitte Gruppe 2 wÃ¤hlen."); return false; }

  // Mindestens eine gefÃ¼llte Zeile in Gruppe 1
  const rows = document.querySelectorAll("#group1 tbody tr");
  let hasAny = false;
  let ok = true;

  rows.forEach(tr=>{
    const name = tr.querySelector(".name");
    const year = tr.querySelector(".year");
    const res  = tr.querySelector(".res");
    const any = name.value.trim() || year.value.trim() || res.value.trim();
    if(!any) return;
    hasAny = true;
    if(!name.value.trim()){ name.classList.add("error"); ok=false; }
    if(!year.value.trim()){ year.classList.add("error"); ok=false; }
    if(!res.value.trim()){ res.classList.add("error"); ok=false; }
  });

  if(!hasAny){ alert("Bitte in Gruppe 1 mindestens einen SchÃ¼tzen erfassen."); return false; }
  if(!ok){ alert("Bitte Pflichtfelder (Name/Jahrgang/Resultat) in erfassten Zeilen ausfÃ¼llen."); return false; }

  return true;
}

/* ===================== E-MAIL TEXT ===================== */
function buildEmailBody(){
  const t1 = +sum1.textContent||0;
  const t2 = +sum2.textContent||0;
  const t3 = group3Enabled ? (+sum3.textContent||0) : 0;

  let body = "";
  body += "Amtscup JungschÃ¼tzen â€“ Cup-Duell\n";
  body += "\nGruppenchef: " + chef.value.trim();
  body += "\nE-Mail: " + email.value.trim();
  body += "\nGruppe 1: " + (g1.value || "-") + " (Summe " + t1 + ")";
  body += "\nGruppe 2: " + (g2.value || "-") + " (Summe " + t2 + ")";
  if(group3Enabled) body += "\nGruppe 3: " + (g3.value || "-") + " (Summe " + t3 + ")";
  body += "\n\nHinweis: Detail-SchÃ¼tzen stehen im Formular (Browser).";
  body += "\nGesendet am: " + new Date().toLocaleString();

  return body;
}

/* ===================== SAVE: SHEETS + MAIL ===================== */
async function saveAll(){
  if(!validate()) return;

  // 1) ZUERST: Google Sheets
  const payload = {
    chef: chef.value.trim(),
    email: email.value.trim(),
    gruppe1: g1.value || "",
    gruppe2: g2.value || "",
    gruppe3: group3Enabled ? (g3.value || "") : "",
    total1: +sum1.textContent||0,
    total2: +sum2.textContent||0,
    total3: group3Enabled ? (+sum3.textContent||0) : 0
  };

  try{
    const r = await fetch(SCRIPT_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify(payload)
    });

    const res = await r.json();
    if(res.status !== "ok"){
      alert("âŒ Google-Sheets Fehler: " + (res.message || "unbekannt"));
      return;
    }

    // 2) DANACH: Mailprogramm Ã¶ffnen (mailto)
    const subject = "Amtscup JungschÃ¼tzen â€“ Resultat " + (g1.value||"") + " vs. " + (g2.value||"");
    const body = buildEmailBody();
    const mailto = "mailto:" + encodeURIComponent(RESULT_EMAIL)
      + "?subject=" + encodeURIComponent(subject)
      + "&body=" + encodeURIComponent(body);

    alert("âœ… In Google-Tabelle gespeichert.\nJetzt Ã¶ffnet sich die E-Mailâ€¦");
    window.location.href = mailto;

  }catch(err){
    alert("âŒ Verbindung fehlgeschlagen (Sheets). PrÃ¼fe SCRIPT_URL / Bereitstellung / Berechtigungen.");
    console.error(err);
  }
}

/* ===================== START ===================== */
(async ()=>{
  try{
    await loadGroups();
  }catch(e){
    alert("Fehler: gruppen.txt konnte nicht geladen werden. Liegt gruppen.txt im gleichen Ordner wie index.html?");
    console.error(e);
  }

  createGroup(1);
  createGroup(2);

  g1.onchange=updateTitles;
  g2.onchange=updateTitles;
})();
</script>
</body>
</html>
