<!doctype html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Jungsch√ºtzen Amtscup</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
*{box-sizing:border-box}
body{font-family:system-ui,sans-serif;background:#eef2f7;margin:0}
.container{max-width:1200px;margin:auto;padding:1rem}
h1{color:#1e3a8a}
h2{color:#1d4ed8}
.card{background:#fff;border-radius:14px;padding:1rem;margin-bottom:1rem;box-shadow:0 4px 10px rgba(0,0,0,.08)}
.row{display:flex;gap:.75rem;flex-wrap:wrap}
.field{flex:1;min-width:220px}
label{font-size:.8rem;font-weight:600}
input,select{width:100%;padding:.45rem;border-radius:8px;border:1px solid #cbd5f5;font-size:14px}
table{width:100%;border-collapse:collapse;font-size:.85rem}
th,td{border:1px solid #e5e7eb;padding:.35rem;text-align:center}
th{background:#dbeafe}
td.name input{width:100%}
td.year input{width:70px;text-align:center}
td.gender select{width:60px}
td.res input{width:60px;text-align:center}
button{border:none;border-radius:999px;padding:.9rem;font-size:1rem;cursor:pointer;background:#2563eb;color:white;width:100%}
.winner-ok{background:#dcfce7;padding:.7rem;border-radius:12px;font-weight:700}
.winner-none{background:#e5e7eb;padding:.7rem;border-radius:12px}
pre{white-space:pre-wrap;font-size:.85rem;background:#f1f5f9;padding:1rem;border-radius:12px}
</style>
</head>

<body>
<div class="container">

<h1>Jungsch√ºtzen Amtscup</h1>

<div class="card">
<h2>Anleitung</h2>
<p>
Du kannst eine oder zwei Gruppen melden, bei 3er Paarungen alle 3 Gruppen m√∂glich.<br>
Mindestens eine Gruppe muss komplett ausgef√ºllt sein.<br>
Die Resultate gehen direkt in die Access-Ranglisten ‚Äì bitte die Namen exakt und korrekt erfassen.<br>
Nach dem Senden dem Mail das Standblatt als Datei oder Bild anh√§ngen.
</p>
<p>üî• Danke f√ºr das Melden der Resultate √ºber diese App</p>
</div>

<div class="card">
<h2>1. Gruppenauswahl</h2>
<div class="row">
 <div class="field"><label>Gruppe 1 *</label><select id="g1"></select></div>
 <div class="field"><label>Gruppe 2</label><select id="g2"></select></div>
 <div class="field"><label>Gruppe 3</label><select id="g3"></select></div>
</div>
</div>

<div id="groups"></div>

<div class="card">
<h2>Sieger</h2>
<div id="winner" class="winner-none">‚Äì</div>
</div>

<div class="card">
<h2>Wichtig</h2>
<p>
Nach dem Klicken auf <b>‚ÄûResultat √ºbermitteln‚Äú</b> wird ein Mail ge√∂ffnet.<br>
Bitte diesem Mail unbedingt das <b>Standblatt als Bild oder Datei anh√§ngen</b>,  
sonst gilt das Resultat als unvollst√§ndig.
</p>
</div>

<div class="card">
<button onclick="submitResult()">üîµ Resultat √ºbermitteln</button>
</div>

<div class="card">
<h2>√úbermitteltes Resultat</h2>
<pre id="output">Noch kein Resultat √ºbermittelt.</pre>
</div>

</div>

<script>
const RESULT_EMAIL = "thomannpeter@bluewin.ch";
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxxbYk7pwn6JpTkzkX3iVAnqBD2yI-z3aVWkuMWst2DwkxTkAX_WfiFiNTNOMvwZ_z9/exec";
const state = {};

async function loadGroups(){
 let list = [];
 try{
  const r = await fetch("gruppen.txt?v=" + Date.now());
  if(!r.ok) throw "Fehlt";
  list = (await r.text()).split(/\r?\n/).filter(Boolean);
 }catch(e){
  list = ["Gruppe A","Gruppe B","Gruppe C"];
 }
 ["g1","g2","g3"].forEach(id=>{
  const s = document.getElementById(id);
  s.innerHTML = "<option value=''>Bitte w√§hlen‚Ä¶</option>";
  list.forEach(g => s.add(new Option(g,g)));
  s.onchange = () => selectGroup(id);
 });
}

function selectGroup(id){
 const name = document.getElementById(id).value;
 if(!name) return;
 if(!state[id]) state[id] = { name, rows:[{},{},{},{}] };
 else state[id].name = name;
 renderGroups();
}

function renderGroups(){
 groups.innerHTML="";
 Object.keys(state).forEach((id,i)=>{
  const g = state[id];
  const c = document.createElement("div");
  c.className="card";
  c.innerHTML = `
   <h2>Sch√ºtzen ‚Äì Gruppe ${i+1}: ${g.name}</h2>
   <table>
    <thead><tr><th>#</th><th>Name</th><th>Jahrgang</th><th>Gender</th><th>Resultat</th></tr></thead>
    <tbody></tbody>
    <tfoot><tr><th colspan="4">Summe</th><th class="sum">0</th></tr></tfoot>
   </table>`;
  const tb = c.querySelector("tbody");

  g.rows.forEach((r,idx)=>{
   const tr = document.createElement("tr");
   tr.innerHTML = `
    <td>${idx+1}</td>
    <td class="name"><input value="${r.n||""}"></td>
    <td class="year"><input value="${r.y||""}"></td>
    <td class="gender">
      <select>
        <option value=""></option>
        <option value="m" ${r.g==="m"?"selected":""}>m</option>
        <option value="w" ${r.g==="w"?"selected":""}>w</option>
      </select>
    </td>
    <td class="res"><input value="${r.r||""}"></td>`;
   const i = tr.querySelectorAll("input,select");
   i[0].oninput = e => r.n = e.target.value;
   i[1].oninput = e => r.y = e.target.value;
   i[2].onchange = e => r.g = e.target.value;
   i[3].oninput = e => { r.r = e.target.value; updateSum(c,g); };
   tb.appendChild(tr);
  });
  groups.appendChild(c);
  updateSum(c,g);
 });
 calcWinner();
}

function updateSum(card,g){
 card.querySelector(".sum").textContent =
  g.rows.reduce((a,b)=>a+(+b.r||0),0);
 calcWinner();
}

function calcWinner(){
 const arr = Object.values(state)
  .map(g=>({ n:g.name, t:g.rows.reduce((a,b)=>a+(+b.r||0),0) }))
  .filter(x=>x.t>0);
 if(arr.length < 2){
  winner.textContent = "‚Äì";
  winner.className = "winner-none";
  return;
 }
 arr.sort((a,b)=>b.t-a.t);
 winner.className = "winner-ok";
 let html = `üèÜ Sieger: ${arr[0].n} (${arr[0].t})<br>`;
 if(arr[1]) html += `ü•à Zweiter: ${arr[1].n} (${arr[1].t})<br>`;
 if(arr[2]) html += `ü•â Dritter: ${arr[2].n} (${arr[2].t})`;
 winner.innerHTML = html;
}

function isGroupComplete(g){
 return g.rows.every(r => r.n && r.y && r.g && r.r);
}

function submitResult(){

 const hasComplete = Object.values(state).some(g => isGroupComplete(g));
 if(!hasComplete){
  alert("Es kann nur gesendet werden, wenn mindestens eine Gruppe vollst√§ndig ausgef√ºllt ist.\nNicht alle Felder sind ausgef√ºllt.");
  return;
 }

 let mailText = "JUNGSCH√úTZEN AMTSCUP ‚Äì RESULTAT\n\n";
 let payload = [];

 Object.values(state).forEach((g,idx)=>{
  const sum = g.rows.reduce((a,b)=>a+(+b.r||0),0);
  mailText += "GRUPPE " + (idx+1) + ": " + g.name + "\n";
  mailText += "Nr; Name; Jahrgang; Gender; Resultat\n";
  g.rows.forEach((r,i)=>{
   if(r.n || r.r){
    mailText +=
     (i+1)+"; "+(r.n||"")+"; "+(r.y||"")+"; "+(r.g||"")+"; "+(r.r||"0")+"\n";
    payload.push({
      gruppe:g.name,nr:i+1,name:r.n||"",jahrgang:r.y||"",gender:r.g||"",resultat:r.r||0,gruppenSumme:sum
    });
   }
  });
  mailText += "Summe: " + sum + "\n\n";
 });

 document.getElementById("output").textContent = mailText;

 window.open(
  "mailto:"+RESULT_EMAIL+
  "?subject="+encodeURIComponent("Jungsch√ºtzen Amtscup Resultat")+
  "&body="+encodeURIComponent(mailText)
 );

 const form = document.createElement("form");
 form.method="POST";
 form.action=GOOGLE_SCRIPT_URL;
 const inp = document.createElement("input");
 inp.type="hidden";
 inp.name="data";
 inp.value=JSON.stringify({ daten: payload, zeit: new Date().toISOString() });
 form.appendChild(inp);
 document.body.appendChild(form);
 form.submit();
}

loadGroups();
</script>
</body>
</html>
